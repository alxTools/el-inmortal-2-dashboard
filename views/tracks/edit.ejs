<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container" style="padding-top: 40px; max-width: 700px;">
        <h1 style="color: #ffd700; margin-bottom: 30px;">‚úèÔ∏è Editar Tema: <%= track.title %></h1>

        <div class="section">
            <form action="/tracks/<%= track.id %>?_method=PUT" method="POST">
                <div class="form-row">
                    <div class="form-group">
                        <label>N√∫mero de Track</label>
                        <input type="number" name="track_number" value="<%= track.track_number %>" readonly style="background: rgba(255,255,255,0.05);">
                    </div>
                    <div class="form-group">
                        <label>T√≠tulo del Tema</label>
                        <input type="text" name="title" value="<%= track.title %>" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Productor</label>
                        <select name="producer_id">
                            <option value="">Sin asignar</option>
                            <% producers.forEach(producer => { %>
                                <option value="<%= producer.id %>" <%= track.producer_id == producer.id ? 'selected' : '' %>><%= producer.name %></option>
                            <% }) %>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Grabaci√≥n</label>
                        <input type="date" name="recording_date" value="<%= track.recording_date %>">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Duraci√≥n</label>
                        <input type="text" name="duration" value="<%= track.duration %>">
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select name="status">
                            <option value="pending" <%= track.status === 'pending' ? 'selected' : '' %>>Pendiente</option>
                            <option value="in_progress" <%= track.status === 'in_progress' ? 'selected' : '' %>>En Progreso</option>
                            <option value="completed" <%= track.status === 'completed' ? 'selected' : '' %>>Completado</option>
                        </select>
                    </div>
                </div>

                <!-- Track Type Selection -->
                <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 10px; padding: 20px; margin: 25px 0;">
                    <h3 style="color: #ffd700; margin-bottom: 15px; font-size: 1.1em;">üéØ Tipo de Lanzamiento</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="is_single" value="1" <%= track.is_single ? 'checked' : '' %> style="width: 20px; height: 20px; accent-color: #ff6b6b;">
                                <span>üéØ Es Sencillo (Single Principal)</span>
                            </label>
                            <p style="font-size: 0.85em; color: #888; margin-top: 5px; margin-left: 30px;">
                                Este tema se promocionar√° como sencillo principal con video y marketing intensivo
                            </p>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="is_primary" value="1" <%= track.is_primary ? 'checked' : '' %> style="width: 20px; height: 20px; accent-color: #ffd700;">
                                <span>‚≠ê Es Track Principal</span>
                            </label>
                            <p style="font-size: 0.85em; color: #888; margin-top: 5px; margin-left: 30px;">
                                Track destacado del √°lbum con contenido adicional (Reels, TikToks, etc.)
                            </p>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Track (Opcional)</label>
                            <select name="track_type">
                                <option value="album" <%= track.track_type === 'album' || !track.track_type ? 'selected' : '' %>>üíø Track de √Ålbum</option>
                                <option value="single" <%= track.track_type === 'single' ? 'selected' : '' %>>üéØ Sencillo Principal</option>
                                <option value="promo" <%= track.track_type === 'promo' ? 'selected' : '' %>>üì¢ Track Promocional</option>
                                <option value="bonus" <%= track.track_type === 'bonus' ? 'selected' : '' %>>üéÅ Track Bonus</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Letras/Notas</label>
                    <textarea name="lyrics" id="lyricsTextarea" rows="6" style="font-family: monospace; font-size: 0.9em;"><%= track.lyrics %></textarea>
                    
                    <% if (track.audio_file_path) { %>
                    <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                        <button type="button" id="transcribeBtn" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                            üé§ Transcribir Letra con IA
                        </button>
                        <span id="transcribeStatus" style="color: #888; font-size: 0.9em; display: none;">
                            ‚è≥ Transcribiendo...
                        </span>
                    </div>
                    <p style="font-size: 0.8em; color: #666; margin-top: 8px; margin-left: 5px;">
                        üí° Usa IA para transcribir autom√°ticamente la letra desde el audio subido
                    </p>
                    <% } %>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="submit" class="btn">üíæ Actualizar Tema</button>
                    <a href="/tracks" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>
        </div>

        <!-- File Upload Section -->
        <div class="section" style="margin-top: 40px;">
            <h2 style="color: #ffd700; margin-bottom: 25px;">üìÅ Archivos del Tema</h2>

            <!-- Audio Player Section -->
            <% if (track.audio_file_path) { %>
            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                <h3 style="color: #ffd700; margin-bottom: 15px; font-size: 1.1em;">üéµ Audio Subido</h3>
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <span class="status-badge <%= track.audio_file_type === 'master' ? 'status-done' : (track.audio_file_type === 'acapella' ? 'status-pending' : 'status-urgent') %>">
                        <%= track.audio_file_type ? track.audio_file_type.toUpperCase() : 'ARCHIVO' %>
                    </span>
                    <span style="color: #888; font-size: 0.9em;">
                        <%= track.audio_file_path.split('/').pop() %>
                    </span>
                </div>
                
                <!-- Audio Player -->
                <audio controls style="width: 100%; margin-top: 10px;" id="audioPlayer">
                    <source src="<%= track.audio_file_path %>" type="audio/mpeg">
                    <source src="<%= track.audio_file_path %>" type="audio/wav">
                    Tu navegador no soporta el reproductor de audio.
                </audio>
                
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button id="playAudioBtn" class="btn" style="padding: 8px 15px; font-size: 0.85em;">‚ñ∂Ô∏è Play</button>
                    <button id="pauseAudioBtn" class="btn btn-secondary" style="padding: 8px 15px; font-size: 0.85em;">‚è∏Ô∏è Pause</button>
                    <a href="<%= track.audio_file_path %>" download class="btn btn-secondary" style="padding: 8px 15px; font-size: 0.85em; text-decoration: none;">‚¨áÔ∏è Descargar</a>
                    <button id="showReplaceBtn" class="btn" style="padding: 8px 15px; font-size: 0.85em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">üîÑ Reemplazar</button>
                    <button id="deleteAudioBtn" class="btn btn-danger" style="padding: 8px 15px; font-size: 0.85em; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border: none;">üóëÔ∏è Eliminar</button>
                </div>
                
                <!-- Replace Audio Section (Hidden by default) -->
                <div id="replaceAudioSection" style="display: none; margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border: 1px dashed rgba(102, 126, 234, 0.5); border-radius: 8px;">
                    <h4 style="color: #667eea; margin-bottom: 10px; font-size: 0.95em;">üîÑ Reemplazar Audio</h4>
                    <form id="replaceAudioForm" enctype="multipart/form-data">
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label style="font-size: 0.9em;">Nuevo Archivo de Audio</label>
                            <input type="file" name="audio_file" id="replaceAudioFile" accept="audio/*" required 
                                   style="padding: 8px; background: rgba(0,0,0,0.3); border: 1px dashed #667eea; border-radius: 5px; color: #fff; font-size: 0.9em;">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label style="font-size: 0.9em;">Tipo de Archivo</label>
                            <select name="file_type" id="replaceFileType" required style="font-size: 0.9em;">
                                <option value="">Seleccionar...</option>
                                <option value="master">üéöÔ∏è MASTER</option>
                                <option value="acapella">üé§ ACAPELLA</option>
                                <option value="beat">ü•Å BEAT</option>
                                <option value="show">üé≠ SHOW</option>
                                <option value="rough">üîß ROUGH MIX</option>
                                <option value="demo">üí° DEMO</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn" style="padding: 8px 15px; font-size: 0.85em;">‚úÖ Confirmar Reemplazo</button>
                            <button type="button" id="hideReplaceBtn" class="btn btn-secondary" style="padding: 8px 15px; font-size: 0.85em;">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
            <% } %>

            <!-- Cover Image Section -->
            <% if (track.cover_image_path) { %>
            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                <h3 style="color: #ffd700; margin-bottom: 15px; font-size: 1.1em;">üñºÔ∏è Cover del Track</h3>
                <img src="<%= track.cover_image_path %>" alt="Cover" style="max-width: 300px; border-radius: 10px; border: 2px solid #ffd700;">
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <a href="<%= track.cover_image_path %>" download class="btn btn-secondary" style="padding: 8px 15px; font-size: 0.85em; text-decoration: none;">‚¨áÔ∏è Descargar Imagen</a>
                    <button id="deleteCoverBtn" class="btn btn-danger" style="padding: 8px 15px; font-size: 0.85em; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border: none;">üóëÔ∏è Eliminar Cover</button>
                </div>
            </div>
            <% } %>

            <!-- Upload Audio Form -->
            <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                <h3 style="color: #ffd700; margin-bottom: 15px; font-size: 1.1em;">üéµ Subir Archivo de Audio</h3>
                <form id="audioUploadForm" enctype="multipart/form-data">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Archivo</label>
                            <select name="file_type" id="fileType" required>
                                <option value="">Seleccionar...</option>
                                <option value="master">üéöÔ∏è MASTER - Versi√≥n final masterizada</option>
                                <option value="acapella">üé§ ACAPELLA - Solo voz sin beat</option>
                                <option value="beat">ü•Å BEAT - Instrumental sin voz</option>
                                <option value="show">üé≠ SHOW - Versi√≥n para presentaciones en vivo</option>
                                <option value="rough">üîß ROUGH MIX - Mezcla preliminar</option>
                                <option value="demo">üí° DEMO - Versi√≥n de demostraci√≥n</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Archivo de Audio (WAV, MP3, M4A, FLAC - Max 100MB)</label>
                        <input type="file" name="audio_file" id="audioFile" accept="audio/*" required 
                               style="padding: 10px; background: rgba(0,0,0,0.3); border: 1px dashed #ffd700; border-radius: 5px; color: #fff;">
                    </div>
                    
                    <div id="audioUploadProgress" style="display: none; margin-top: 15px;">
                        <div style="background: rgba(255, 215, 0, 0.2); height: 20px; border-radius: 10px; overflow: hidden;">
                            <div id="audioProgressBar" style="background: linear-gradient(90deg, #ffd700, #ffed4e); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <p id="audioUploadStatus" style="color: #888; font-size: 0.85em; margin-top: 5px;">Subiendo...</p>
                    </div>
                    
                    <button type="submit" class="btn" style="margin-top: 15px;">
                        üì§ Subir Audio
                    </button>
                </form>
            </div>

            <!-- Upload Cover Image Form -->
            <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; padding: 20px;">
                <h3 style="color: #ffd700; margin-bottom: 15px; font-size: 1.1em;">üñºÔ∏è Subir Cover del Track</h3>
                <form id="coverUploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>Imagen de Cover (JPG, PNG, WEBP - Recomendado 3000x3000px)</label>
                        <input type="file" name="cover_image" id="coverImage" accept="image/*" required
                               style="padding: 10px; background: rgba(0,0,0,0.3); border: 1px dashed #ffd700; border-radius: 5px; color: #fff;">
                    </div>
                    
                    <div id="coverPreview" style="display: none; margin-top: 15px;">
                        <p style="color: #888; font-size: 0.9em; margin-bottom: 10px;">Vista previa:</p>
                        <img id="coverPreviewImg" src="" alt="Preview" style="max-width: 200px; border-radius: 10px; border: 2px solid #ffd700;">
                    </div>
                    
                    <button type="submit" class="btn" style="margin-top: 15px;">
                        üì§ Subir Cover
                    </button>
                </form>
            </div>
        </div>

        <!-- Activity Log Section -->
        <div class="section" style="margin-top: 40px; background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 215, 0, 0.2);">
            <h2 style="color: #ffd700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                üìã Historial de Actividades
                <span style="font-size: 0.6em; color: #888; font-weight: normal;">(Logs de cambios)</span>
            </h2>
            
            <div id="activityLogContainer" style="max-height: 400px; overflow-y: auto; border-radius: 8px; background: rgba(0, 0, 0, 0.3);">
                <div id="activityLogList">
                    <p style="color: #888; text-align: center; padding: 30px;">
                        ‚è≥ Cargando historial...
                    </p>
                </div>
            </div>
            
            <div style="margin-top: 15px; padding: 15px; background: rgba(255, 215, 0, 0.05); border-radius: 8px; border-left: 3px solid #ffd700;">
                <p style="color: #888; font-size: 0.85em; margin: 0;">
                    üí° <strong>Registro autom√°tico:</strong> Todas las acciones (subir, eliminar, reemplazar audio) se guardan autom√°ticamente con fecha y hora.
                </p>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script>
        // Audio player controls
        function playAudio() {
            const player = document.getElementById('audioPlayer');
            if (player) player.play();
        }
        
        function pauseAudio() {
            const player = document.getElementById('audioPlayer');
            if (player) player.pause();
        }

        // Handle audio upload
        document.getElementById('audioUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const fileInput = document.getElementById('audioFile');
            const fileTypeInput = document.getElementById('fileType');
            
            // Debug logging
            console.log('DEBUG: File selected:', fileInput.files[0]?.name || 'No file');
            console.log('DEBUG: File type selected:', fileTypeInput.value);
            console.log('DEBUG: Track ID:', <%= track.id %>);
            
            if (!fileInput.files[0]) {
                alert('‚ùå Por favor selecciona un archivo de audio');
                return;
            }
            
            if (!fileTypeInput.value) {
                alert('‚ùå Por favor selecciona el tipo de archivo');
                return;
            }
            
            formData.append('audio_file', fileInput.files[0]);
            formData.append('file_type', fileTypeInput.value);
            
            const progressDiv = document.getElementById('audioUploadProgress');
            const progressBar = document.getElementById('audioProgressBar');
            const statusText = document.getElementById('audioUploadStatus');
            
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            
            const uploadUrl = '/uploads/track/<%= track.id %>/audio';
            console.log('DEBUG: Uploading to:', uploadUrl);
            
            try {
                statusText.textContent = 'Enviando...';
                console.log('DEBUG: Starting fetch request...');
                
                const response = await fetch('/uploads/track/<%= track.id %>/audio', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('DEBUG: Response received:', response.status, response.statusText);
                console.log('DEBUG: Response headers:', [...response.headers.entries()]);
                
                // Check content type
                const contentType = response.headers.get('content-type');
                console.log('DEBUG: Content-Type:', contentType);
                
                if (!response.ok) {
                    // Handle error response
                    let errorMessage = `Error HTTP: ${response.status}`;
                    
                    if (contentType && contentType.includes('application/json')) {
                        const errorResult = await response.json();
                        errorMessage = errorResult.error || errorMessage;
                    } else {
                        const errorText = await response.text();
                        console.error('Server error response:', errorText);
                        if (response.status === 404) {
                            errorMessage = 'Ruta no encontrada. Verifica que el servidor est√© configurado correctamente.';
                        } else if (response.status === 413) {
                            errorMessage = 'Archivo demasiado grande.';
                        } else {
                            errorMessage = `Error del servidor: ${response.status}. Revisa la consola para m√°s detalles.`;
                        }
                    }
                    
                    throw new Error(errorMessage);
                }
                
                // Parse successful response
                let result;
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    result = { success: true, message: 'Subida completada' };
                }
                
                if (result.success) {
                    progressBar.style.width = '100%';
                    statusText.textContent = '‚úÖ ' + (result.message || 'Subida completada!');
                    statusText.style.color = '#28a745';
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error(result.error || 'Error en la subida');
                }
            } catch (error) {
                progressBar.style.width = '0%';
                statusText.textContent = '‚ùå Error: ' + error.message;
                statusText.style.color = '#dc3545';
                console.error('Upload Error:', error);
            }
        });

        // Handle cover image preview
        document.getElementById('coverImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('coverPreviewImg').src = e.target.result;
                    document.getElementById('coverPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle cover upload
        document.getElementById('coverUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('cover_image', document.getElementById('coverImage').files[0]);
            
            try {
                const response = await fetch('/uploads/track/<%= track.id %>/cover', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const contentType = response.headers.get('content-type');
                
                if (!response.ok) {
                    let errorMessage = `Error HTTP: ${response.status}`;
                    
                    if (contentType && contentType.includes('application/json')) {
                        const errorResult = await response.json();
                        errorMessage = errorResult.error || errorMessage;
                    } else {
                        const errorText = await response.text();
                        console.error('Server error response:', errorText);
                        if (response.status === 404) {
                            errorMessage = 'Ruta no encontrada.';
                        } else if (response.status === 413) {
                            errorMessage = 'Archivo demasiado grande.';
                        }
                    }
                    
                    throw new Error(errorMessage);
                }
                
                let result;
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    result = { success: true };
                }
                
                if (result.success) {
                    alert('‚úÖ ' + (result.message || 'Cover subido exitosamente!'));
                    location.reload();
                } else {
                    throw new Error(result.error || 'Error en la subida');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                console.error('Error:', error);
            }
        });

        // Transcribe lyrics from audio
        async function transcribeLyrics() {
            const btn = document.getElementById('transcribeBtn');
            const status = document.getElementById('transcribeStatus');
            const textarea = document.getElementById('lyricsTextarea');
            
            btn.disabled = true;
            status.style.display = 'inline';
            status.textContent = 'üé§ Enviando audio a Whisper API...';
            status.style.color = '#ffd700';
            
            try {
                const response = await fetch('/api/tracks/<%= track.id %>/transcribe', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    textarea.value = result.lyrics;
                    status.textContent = '‚úÖ Letra transcrita y guardada!';
                    status.style.color = '#28a745';
                    
                    // Show success message
                    alert('‚úÖ Transcripci√≥n completada!\n\nLa letra ha sido transcrita usando OpenAI Whisper y guardada autom√°ticamente en la base de datos.');
                    
                    // Show word count
                    const wordCount = result.lyrics.split(/\s+/).filter(w => w.length > 0).length;
                    console.log(`Transcribed ${wordCount} words for track "${result.trackTitle}"`);
                } else {
                    throw new Error(result.error || result.details || 'Error en la transcripci√≥n');
                }
            } catch (error) {
                status.textContent = '‚ùå Error: ' + error.message;
                status.style.color = '#dc3545';
                console.error('Transcription error:', error);
                alert('‚ùå Error al transcribir: ' + error.message + '\n\nAseg√∫rate de que el archivo de audio exista y sea accesible.');
            } finally {
                btn.disabled = false;
            }
        }

        // Show/Hide Replace Audio Section
        function showReplaceAudio() {
            document.getElementById('replaceAudioSection').style.display = 'block';
        }
        
        function hideReplaceAudio() {
            document.getElementById('replaceAudioSection').style.display = 'none';
            document.getElementById('replaceAudioForm').reset();
        }

        // Handle Replace Audio
        document.getElementById('replaceAudioForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const fileInput = document.getElementById('replaceAudioFile');
            const fileTypeInput = document.getElementById('replaceFileType');
            
            if (!fileInput.files[0]) {
                alert('‚ùå Por favor selecciona un archivo de audio');
                return;
            }
            
            formData.append('audio_file', fileInput.files[0]);
            formData.append('file_type', fileTypeInput.value);
            formData.append('replace', 'true'); // Flag to indicate replacement
            
            try {
                const response = await fetch('/uploads/track/<%= track.id %>/audio/replace', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('‚úÖ ' + (result.message || 'Audio reemplazado exitosamente!'));
                    location.reload();
                } else {
                    throw new Error(result.error || 'Error al reemplazar el audio');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                console.error('Replace error:', error);
            }
        });

        // Delete Audio
        async function deleteAudio() {
            try {
                const response = await fetch('/uploads/track/<%= track.id %>/audio', {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('‚úÖ ' + (result.message || 'Audio eliminado exitosamente!'));
                    location.reload();
                } else {
                    throw new Error(result.error || 'Error al eliminar el audio');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                console.error('Delete error:', error);
            }
        }

        // Delete Cover
        async function deleteCover() {
            try {
                const response = await fetch('/uploads/track/<%= track.id %>/cover', {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('‚úÖ ' + (result.message || 'Cover eliminado exitosamente!'));
                    location.reload();
                } else {
                    throw new Error(result.error || 'Error al eliminar el cover');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                console.error('Delete cover error:', error);
            }
        }

        // Load and display activity log
        async function loadActivityLog() {
            try {
                const response = await fetch('/uploads/track/<%= track.id %>/log');
                const result = await response.json();
                
                if (result.success && result.activities) {
                    displayActivityLog(result.activities);
                }
            } catch (error) {
                console.error('Error loading activity log:', error);
            }
        }

        function displayActivityLog(activities) {
            const container = document.getElementById('activityLogContainer');
            const list = document.getElementById('activityLogList');
            
            if (!activities || activities.length === 0) {
                list.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No hay actividades registradas para este tema.</p>';
                return;
            }
            
            list.innerHTML = activities.map(activity => {
                const date = new Date(activity.created_at);
                const dateStr = date.toLocaleDateString('es-ES', { 
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                
                let icon = 'üìù';
                let color = '#888';
                
                switch(activity.action) {
                    case 'AUDIO_UPLOAD':
                        icon = 'üì§';
                        color = '#28a745';
                        break;
                    case 'AUDIO_DELETE':
                        icon = 'üóëÔ∏è';
                        color = '#dc3545';
                        break;
                    case 'AUDIO_REPLACE':
                        icon = 'üîÑ';
                        color = '#667eea';
                        break;
                    case 'LYRICS_TRANSCRIBE':
                        icon = 'üé§';
                        color = '#ffd700';
                        break;
                    case 'COVER_UPLOAD':
                        icon = 'üñºÔ∏è';
                        color = '#22c55e';
                        break;
                    case 'COVER_DELETE':
                        icon = 'üóÇÔ∏è';
                        color = '#f97316';
                        break;
                }
                
                return `
                    <div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 1.2em;">${icon}</span>
                        <div style="flex: 1;">
                            <div style="color: ${color}; font-weight: 600; font-size: 0.9em; margin-bottom: 4px;">
                                ${activity.action.replace(/_/g, ' ')}
                            </div>
                            <div style="color: #ccc; font-size: 0.85em; margin-bottom: 4px;">
                                ${activity.details}
                            </div>
                            <div style="color: #666; font-size: 0.75em;">
                                ${dateStr}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add event listeners for buttons (not using inline onclick due to CSP)
        document.addEventListener('DOMContentLoaded', function() {
            // Load activity log
            loadActivityLog();
            
            // Audio player buttons
            const playBtn = document.getElementById('playAudioBtn');
            const pauseBtn = document.getElementById('pauseAudioBtn');
            if (playBtn) playBtn.addEventListener('click', playAudio);
            if (pauseBtn) pauseBtn.addEventListener('click', pauseAudio);
            
            // Replace audio buttons
            const showReplaceBtn = document.getElementById('showReplaceBtn');
            const hideReplaceBtn = document.getElementById('hideReplaceBtn');
            if (showReplaceBtn) showReplaceBtn.addEventListener('click', showReplaceAudio);
            if (hideReplaceBtn) hideReplaceBtn.addEventListener('click', hideReplaceAudio);
            
            // Delete audio button
            const deleteBtn = document.getElementById('deleteAudioBtn');
            if (deleteBtn) deleteBtn.addEventListener('click', deleteAudio);

            // Delete cover button
            const deleteCoverBtn = document.getElementById('deleteCoverBtn');
            if (deleteCoverBtn) deleteCoverBtn.addEventListener('click', deleteCover);
            
            // Transcribe lyrics button
            const transcribeBtn = document.getElementById('transcribeBtn');
            if (transcribeBtn) transcribeBtn.addEventListener('click', transcribeLyrics);
        });
    </script>
</body>
</html>
